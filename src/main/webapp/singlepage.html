<!DOCTYPE HTML>
<html>
<head>
	<title>正文</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content="" />
	<!--<script type="applijewelleryion/x-javascript"> addEventListener("load", function() { setTimeout(hideURLbar, 0); }, false); function hideURLbar(){ window.scrollTo(0,1); } </script>-->
	<link href="css/bootstrap.css" rel='stylesheet' type='text/css' />
	<!-- Custom Theme files -->
	<!--<link href='http://fonts.useso.com/css?family=Raleway:400,600,700' rel='stylesheet' type='text/css'>-->
	<link href="css/style.css" rel='stylesheet' type='text/css' />
	<script src="js/jquery/jquery-2.1.1.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="script/docs.min.js"></script>
	<script type="text/javascript">
        $(function () {
            // 页眉
            $(".header").load("header.html");
            // // 页尾
            // $(".footer").load("footer.html");
            // 热门
            $(".col-md-3").load("popular.html");

            acquireNews();
            getCommentList();
        });

        /*通过ajax获取数据内容给予前端的展示*/
        function acquireNews() {
            var np_id=window.location.search.split("=")[1];
            console.log(np_id);
            $.ajax({
                type: 'GET',
                url:  "acquireNewsByNewsId?np_id="+np_id,
                contentType: "application/json; charset=utf-8",
                success: function(response){
                    $("#rows").empty();
                    $("#rows").append(
                        "<input type=\"hidden\" id=\"np_id\" value='"+response.np_id+"'>"+
                        "<h2 class=\"w3\">"+response.np_title+"</h2>" +
                        "<div class=\"single\" id=\"newsContent\">" +
                        "<img src='"+response.np_image+"' class=\"img-responsive\" alt=\"\">" +
                        "<div class=\"b-bottom\">" +
                        "<!--<h5 class=\"top\">What turn out consetetur sadipscing elit</h5>-->" +
                        "<p class=\"sub\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+response.np_content+"</p>" +
                        "<p id=\"newsDate\">"+response.np_date+"<a class=\"span_link\" href=\"#\"><span class=\"glyphicon glyphicon-comment\"></span><span id=\"newsLiking\">"+response.np_likes+"</span></a><a class=\"span_link\" href=\"#\"><span class=\"glyphicon glyphicon-eye-open\"></span><span id=\"newsReading\">"+response.np_reading+"</span></a></p>" +
                        "<div style=\"float: right\"><a href='authorHomepage.html?user_id="+response.user_id+"'><img src='"+response.user_imageUrl+"' class=\"img-circle\" width=\"35px\" href=\"35px\"/></a><span style=\"font-size: initial\">"+response.user_alias+"</span><span class=\"caret\"></span></div>" +
                        "</div>" +
                        "</div>");

                } ,
                error:function (message) {
                    console.log(message);
                },
                dataType: 'json'
            });
        }

        /* 根 */
        //获取评论内容
        function getCommentList() {

        }

        //发送评论
        function sendComment() {
            var emailText = $("#email").val().trim();
            var user_id = $("#user_id").val();
            if (user_id == null || user_id == '' || user_id == '0') {
                if (emailText != null && emailText != '') {
                    getUserPower(emailText);
                }
            } else {
                var np_idText = $("#np_id").val();
                var contentText = $("#content").val();

                //确定评论合规开始发送
                if (true) {
                    $.ajax({
                        type: 'POST',
                        url: 'addComment',
                        contentType: "application/json; charset=utf-8",
                        data:JSON.stringify({
                            // "user_id":user_id, //用户id用session里获取以保证安全性
                            "np_id":np_idText,
                            "comment_content":contentText
                        }),
                        dataType: 'json',
                        success: function (Response) {
                            alert(Response);
                        },
                        error: function (response) {
                            console.error(response);
                        }
                    });
                }
            }
        }

        //获取权限
        function getUserPower(emailText) {
            console.log("开始验证权限");
            $.ajax({
                type: 'POST',
                url: 'getUserPower',
                contentType: "application/json; charset=utf-8",
                data:JSON.stringify({
                    "username":emailText
                }),
                dataType: 'json',
                success: function (Response) {
                    if (Response == 0) {
                        alert("该邮箱地址不可用")
                    } else if (Response == '1') {
                        commentByGuess(emailText);// alert("旧游客身份");
                    } else if (Response != '-1') {
                        alert("该邮箱地址已注册，请登录")
                    }
                },
                error: function (response) {
                    console.error(response);
                }
            });
        }

        //得到邮箱对应的账号id
        function commentByGuess(emailText) {
            $.ajax({
                type: 'POST',
                url: 'getUserId',
                contentType: "application/json; charset=utf-8",
                data:JSON.stringify({
                    "username":emailText
                }),
                dataType: 'json',
                success: function (user_id) {
                    if (user_id > 0) {
                        $("#user_id").val(user_id);
                        //
                        sendComment();
                    }
                },
                error: function (response) {
                    console.error(response);
                }
            })
        }
	</script>
</head>
<body>
<div class="header" id="ban">

</div>
<!-- technology-left -->
<div class="technology">
	<div class="container">
		<div class="col-md-9 technology-left">
			<div class="agileinfo">
				<div id="rows">

					<a href="authorHomepage.html?user_id="><img src="" class="img-circle" width="35px" href="35px"/></a>

				</div>
				<div class="coment-form">
					<h4>留下你的评论</h4>
					<form>
						<input type="hidden" id="user_id" value="">
						<input type="email" value="邮箱(*必填)" id="email" onfocus="if (this.value == '邮箱(*必填)') {this.value = '';}" onblur="if (this.value == '') {this.value = '邮箱(*必填)';}" required="">
						<textarea onfocus="if (this.value == '说点什么...') {this.value = '';}" onblur="if (this.value == '') {this.value = '说点什么...';}" required="" id="content">说点什么...</textarea>
						<input type="button" value="发表评论" onclick="sendComment()">
					</form>
				</div>
				<div class="clearfix"></div>
			</div>
		</div>
		<!-- technology-right -->
		<div class="col-md-3 technology-right">
			<!--热门-->
		</div>
		<div class="clearfix"></div>
		<!-- technology-right -->
	</div>
</div>
</body>
</html>