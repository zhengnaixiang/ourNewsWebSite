<!DOCTYPE HTML>
<html>
<head>
    <title>正文</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="keywords" content="" />
    <!--<script type="applijewelleryion/x-javascript"> addEventListener("load", function() { setTimeout(hideURLbar, 0); }, false); function hideURLbar(){ window.scrollTo(0,1); } </script>-->
    <link href="css/bootstrap.css" rel='stylesheet' type='text/css' />
    <!-- Custom Theme files -->
    <!--<link href='http://fonts.useso.com/css?family=Raleway:400,600,700' rel='stylesheet' type='text/css'>-->
    <link href="css/style.css" rel='stylesheet' type='text/css' />
    <script src="js/jquery/jquery-2.1.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="script/docs.min.js"></script>
    <script type="text/javascript">
        $(function () {
            //最先加载新闻内容,用户及评论自动加载
            acquireNews();
            // giveStatus();
            //getCommentList()

            // 页眉
            $(".header").load("header.html");
            // 热门
            $(".col-md-3").load("popular.html");
        });

        var np_id=window.location.search.split("=")[1];

        /*通过ajax获取数据内容给予前端的展示*/
        function acquireNews() {
            $.ajax({
                type: 'GET',
                url:  "acquireNewsByNewsId?np_id="+np_id,
                contentType: "application/json; charset=utf-8",
                success: function(response){
                    $("#rows").empty();
                    $("#rows").append(
                        "<input type=\"hidden\" id=\"np_id\" value='"+response.np_id+"'>"+
                        "<h2 class=\"w3\">"+response.np_title+"</h2>" +
                        "<div class=\"single\" id=\"newsContent\">" +
                        "<img src='"+response.np_image+"' class=\"img-responsive\" alt=\"\">" +
                        "<div class=\"b-bottom\">" +
                        "<!--<h5 class=\"top\">What turn out consetetur sadipscing elit</h5>-->" +
                        "<p class=\"sub\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+response.np_content+"</p>" +
                        "<p id=\"newsDate\">"+response.np_date+"<a class=\"span_link\" href=\"#\"><span class=\"glyphicon glyphicon-comment\"></span><span id=\"newsLiking\">"+response.np_likes+"</span></a><a class=\"span_link\" href=\"#\"><span class=\"glyphicon glyphicon-eye-open\"></span><span id=\"newsReading\">"+response.np_reading+"</span></a></p>" +
                        "<div style=\"float: right\"><a href='authorHomepage.html?user_id="+response.user_id+"'><img src='"+response.user_imageUrl+"' class=\"img-circle\" width=\"35px\" href=\"35px\"/></a><span style=\"font-size: initial\">"+response.user_alias+"</span><span class=\"caret\"></span></div>" +
                        "</div>" +
                        "</div>");
                    // 完成新闻内容加载后继而加载用户状态
                    giveStatus();
                } ,
                error:function (message) {
                    console.log(message);
                },
                dataType: 'json'
            });
        }

        //从session获取用户信息
        function giveStatus() {
            $.ajax({
                type: 'GET',
                url:  'giveStatus',
                dataType: 'json',
                success: function(response){
                    if (response) {
                        $("#user_id").val(response.user_id);
                        $("#email").val(response.username).hide();
                    }
                    // 得到用户结果后再解析评论
                    getCommentList();
                } ,
                error:function (message) {
                    // console.log(message);
                    // 用户模块出错依然加载评论
                    getCommentList();
                }
            });
        }

        /* 根 */
        //获取评论内容
        function getCommentList() {
            var user_id = $("#user_id").val();
            var requestUrl = 'getCommentByNpId?np_id='+np_id;
            if (user_id >1) {
                requestUrl = 'getNpCommentByUserId?np_id='+np_id+"&user_id="+user_id;
            }
            $.ajax({
                type: 'GET',
                url: requestUrl,
                contentType: "application/json; charset=utf-8",
                dataType: 'json',
                success: function (commentList) {
                    $("#commentShow").empty();
                    $(commentList).each(function (index, item) {
                        if (item.user_imageUrl == null) {
                            item.user_imageUrl = 'images/head/0.jpg'
                        }
                        if (item.user_alias == null) {
                            item.user_alias = '游客'
                        }
                        $("#commentShow").append(
                            "<div class=\"media-left response-text-left &nbsp "+item.comment_id+"\">" +
                            // "<input class='user_alias' value='"+item.user_alias+"' "+
                            "<a href='authorHomepage.html?user_id="+item.user_id+"'>" +
                            "<img src='"+item.user_imageUrl+"' class=\"img-responsive\" alt=\"\">" +
                            "</a>" +
                            "</div>" +
                            "<div class=\"media-body response-text-right\">" +
                            "<h5>"+item.user_alias+"</h5>" +
                            "<p>"+item.comment_content+"</p>" +
                            "<ul class='commentUser"+item.user_id+"'>" +
                            "<li>"+item.comment_date+"</li>&nbsp&nbsp" +
                            "<li onclick='target(this)' value='"+item.comment_id+"' >回复："+item.user_alias+"</li>&nbsp&nbsp" +
                            "<li style='display:none' onclick='rewrite("+item.comment_id+")' >修改</li>&nbsp&nbsp" +
                            "<li style='display:none' onclick='del("+item.comment_id+")' >删除</li>"+
                            "</ul>" +
                            "<div class='respon'></div>"+
                            "</div>" +
                            "</div>" +
                            "<div class=\"clearfix\"> </div>"
                        );
                        if (item.commentList != null) {
                            $(item.commentList).each(function (index2, item2) {
                                if (item2.user_imageUrl == null) {
                                    item2.user_imageUrl = 'images/head/0.jpg'
                                }
                                if (item2.user_alias == null) {
                                    item2.user_alias = '游客'
                                }
                                $(".respon:last").append(
                                    "<div class=\"media response-info\">" +
                                    "<div class=\"media-left response-text-left\">" +
                                    "<a href='authorHomepage.html?user_id="+item2.user_id+"'>" +
                                    "<img src='"+item2.user_imageUrl+"' class=\"img-responsive\" alt=\"\">" +
                                    "</a>" +
                                    "</div>" +
                                    "<div class=\"media-body response-text-right\">" +
                                    "<h5>"+item2.user_alias+"</h5>" +
                                    "<p>"+item2.comment_content+"</p>" +
                                    "<ul class='commentUser"+item2.user_id+"'>" +
                                    "<li>"+item2.comment_date+"</li>&nbsp&nbsp" +
                                    "<li></li>" +
                                    "<li style='display:none' onclick='rewrite("+item2.comment_id+")' >修改</li>&nbsp&nbsp" +
                                    "<li style='display:none' onclick='del("+item2.comment_id+")' >删除</li>"+
                                    "</ul>" +
                                    "</div>" +
                                    "<div class=\"clearfix\"></div>"
                                );
                            })
                        }

                    });
                    var t = $(".commentUser"+user_id+" li");
                    // 前账号的评论进行定制化接口
                    // 不能回复自己，可以修改，可以删除。
                    // console.log(t);
                    for (var i = 0; i < t.length/4; i++) {
                        var gap = i*4;
                        t[gap+1].style.display = 'none';
                        t[gap+2].style.display = 'inline';
                        t[gap+3].style.display = 'inline'
                    }
                    // t[0].hide();
                },
                error: function (response) {
                    console.error(response);
                }
            });
        }

        //发送评论
        function sendComment() {
            var emailText = $("#email").val().trim();
            var user_id = $("#user_id").val();
            if (user_id == null || user_id == '' || user_id == '0') {
                //如果email窗口被隐藏即用户已经登录，不需要判断权限。
                if (emailText != null && !$("#email").is(':hidden')) {
                    getUserPower(emailText);
                }
            } else {
                var np_idText = $("#np_id").val();
                var targetText = $("#target").val().split(":")[1];
                var contentText = $("#content").val();
                var captchaText = $("#captcha").val().trim();

                //确定评论合规开始发送
                if (true) {
                    $.ajax({
                        type: 'POST',
                        url: 'addComment',
                        contentType: "application/json; charset=utf-8",
                        data:JSON.stringify({
                            // "user_id":user_id, //前端页面不需提交用户id，用户id由服务器从session里获取
                            "np_id":np_idText,
                            "parent_id":targetText,
                            "comment_content":contentText,
                            "yzm":captchaText
                        }),
                        // dataType: 'json',
                        success: function (Response) {
                            if (Response === 'yzm_error') {
                                alert("验证码错误！")
                            } else if (Response) {
                                // getCommentList();
                                window.location.reload()
                            } else {
                                alert("评论发送失败");
                            }
                        },
                        error: function (response) {
                            console.error(response);
                        }
                    });
                }
            }
        }

        //获取权限
        function getUserPower(emailText) {
            $.ajax({
                type: 'GET',
                url: 'getUserPower?username='+emailText,
                contentType: "application/json; charset=utf-8",
                // data:JSON.stringify({
                //     "username":emailText
                // }),
                dataType: 'json',
                success: function (Response) {
                    if (Response == 0) {
                        alert("该邮箱地址不可用")
                    } else if (Response == '1') {
                        commentByGuess(emailText);// alert("旧游客身份");
                    } else if (Response != '-1') {
                        alert("该邮箱地址已注册，请登录")
                    }
                },
                error: function (response) {
                    console.error(response);
                }
            });
        }

        //得到邮箱对应的账号id
        function commentByGuess(emailText) {
            $.ajax({
                type: 'GET',
                url: 'getUserId?username='+emailText,
                contentType: "application/json; charset=utf-8",
                // data:JSON.stringify({
                //     "username":emailText
                // }),
                dataType: 'json',
                success: function (user_id) {
                    if (user_id > 0) {
                        $("#user_id").val(user_id);
                        // 获取user_id,同时服务器session会登记对应userInfo
                        // (*)发表评论必须session存在带id的userInfo
                        sendComment();
                    }
                },
                error: function (response) {
                    console.error(response);
                }
            })
        }

        // 回复
        function target(t) {
            $("#targetAlias").show();
            $("#target").val(t.value);
            $("#targetAlias").val("正在回复："+t.innerText.split("：")[1]);
        }

        // 删除
        function del(comment_id) {
            // console.log("删除评论"+comment_id)
            $.ajax({
                type: 'GET',
                url: 'deleteComment?comment_id='+comment_id,
                dataType: 'json',
                success: function (response) {
                    if (response) {
                        alert("删除成功");
                        getCommentList();
                    } else {
                        alert("删除失败")
                    }
                },
                error: function (response) {
                    console.error(response);
                }
            })
        }

        // 修改
        function rewrite(commentId) {
            console.log(commentId);
            var test = $(".media-left "+commentId);
            console.log(test)
        }
    </script>
</head>
<body>
<div class="header" id="ban">

</div>
<!-- technology-left -->
<div class="technology">
    <div class="container">
        <div class="col-md-9 technology-left">
            <div class="agileinfo">
                <div id="rows">
                    <!--内容-->
                </div>
                <div class="response">
                    <h4>评论区</h4>
                    <div class="media response-info" id="commentShow">
                        <!--评论内容-->
                        <div class="clearfix"> </div>
                    </div>
                </div>
                <div class="coment-form">
                    <h4>留下你的评论</h4>
                    <form>
                        <input type="hidden" id="user_id" value="">
                        <input type="hidden" id="target" value="" readonly="readonly" >
                        <input type="email" value="邮箱(*必填)" id="email" onfocus="if (this.value == '邮箱(*必填)') {this.value = '';}" onblur="if (this.value == '') {this.value = '邮箱(*必填)';}" required="">
                        <input style="display: none;" type="text" id="targetAlias" value="" readonly="readonly" >
                        <textarea onfocus="if (this.value == '说点什么...') {this.value = '';}" onblur="if (this.value == '') {this.value = '说点什么...';}" required="" id="content">说点什么...</textarea>

                        <input type="text" id="captcha" style="width: 150px; height: 30px">
                        <img alt="验证码找不到" src="tryCaptcha.jpg" style="width: 150px; height: 30px" />
                        <!--<input type="text" class="form-control" id="kaptcha" name="kaptcha" placeholder="请输入验证码" style="color:#000000;"/>-->
                        <!--<img src="tryCaptcha.jpg" width="100" id="kaptchaImage" title="看不清，点击换一张" />-->
                        <!--<br/>-->

                        <input type="button" value="发表评论" onclick="sendComment()">

                    </form>
                </div>
                <div class="clearfix"></div>
            </div>
        </div>
        <!-- technology-right -->
        <div class="col-md-3 technology-right">
            <!--热门-->
        </div>
        <div class="clearfix"></div>
        <!-- technology-right -->
    </div>
</div>
</body>
</html>